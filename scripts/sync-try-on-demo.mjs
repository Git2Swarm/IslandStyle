#!/usr/bin/env node
import { promises as fs } from 'fs';
import { join, resolve } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = resolve(__filename, '..');
const rootDir = resolve(__dirname, '..');
const dataDir = join(rootDir, 'data', 'try-on');
const overlaysDir = join(dataDir, 'overlays');
const outputFile = join(rootDir, 'assets', 'js', 'try-on-data.js');

function escapeTemplateLiteral(value) {
  return value.replace(/`/g, '\\`').replace(/\$\{/g, '\\${');
}

function indent(value, spaces) {
  const padding = ' '.repeat(spaces);
  return value
    .split('\n')
    .map((line) => (line.length ? padding + line : line))
    .join('\n');
}

async function loadConfig() {
  const [overlaysJson, portraitSvg] = await Promise.all([
    fs.readFile(join(dataDir, 'overlays.json'), 'utf8'),
    fs.readFile(join(dataDir, 'sample-portrait.svg'), 'utf8'),
  ]);

  const overlays = JSON.parse(overlaysJson);
  return { overlays, portraitSvg: portraitSvg.trim() };
}

async function loadOverlaySvgs(overlays) {
  return Promise.all(
    overlays.map(async (overlay) => {
      const svgPath = join(overlaysDir, overlay.overlayFile);
      const svg = await fs.readFile(svgPath, 'utf8');
      return { ...overlay, svg: svg.trim() };
    })
  );
}

function buildFileContents(portraitSvg, overlays) {
  const portraitBlock = indent(escapeTemplateLiteral(portraitSvg), 4);

  const overlaysBlock = overlays
    .map((overlay) => {
      const overlaySvg = indent(escapeTemplateLiteral(overlay.svg), 8);
      return [
        '    {',
        `      id: '${overlay.id}',`,
        `      name: '${overlay.name}',`,
        `      color: '${overlay.color}',`,
        `      description: '${overlay.description}',`,
        `      widthPercent: ${overlay.widthPercent},`,
        `      defaultScale: ${overlay.defaultScale},`,
        `      defaultOffsetX: ${overlay.defaultOffsetX},`,
        `      defaultOffsetY: ${overlay.defaultOffsetY},`,
        '      overlaySvg: `',
        overlaySvg,
        '      `,',
        '    }',
      ].join('\n');
    })
    .join(',\n\n');

  return `/* Auto-generated by scripts/sync-try-on-demo.mjs; do not edit manually. */\n(function () {\n  function encodeSvg(svg) {\n    return \`data:image/svg+xml;utf8,\${encodeURIComponent(svg.replace(/\\s+/g, ' ').trim())}\`;\n  }\n\n  const samplePortraitSvg = \`\n${portraitBlock}\n  \`;\n\n  const overlays = [\n${overlaysBlock}\n  ];\n\n  window.TRY_ON_WIGS = overlays.map((overlay) => ({\n    id: overlay.id,\n    name: overlay.name,\n    color: overlay.color,\n    description: overlay.description,\n    widthPercent: overlay.widthPercent,\n    defaultScale: overlay.defaultScale,\n    defaultOffsetX: overlay.defaultOffsetX,\n    defaultOffsetY: overlay.defaultOffsetY,\n    overlay: encodeSvg(overlay.overlaySvg),\n    thumb: encodeSvg(\`\n      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 220 220">\n        <rect width="220" height="220" rx="28" fill="#f4ede5" />\n        <circle cx="110" cy="94" r="56" fill="#f6c8a8" />\n        <path d="M46 110c-2-68 50-116 110-116s112 48 110 116c-2 68-48 112-110 118-62-6-108-50-110-118Z" fill="\${overlay.color.replace(/\\s+/g, '%20')}" fill-opacity="0.75" />\n      </svg>\n    \`),\n  }));\n\n  window.TRY_ON_SAMPLE_PORTRAIT = encodeSvg(samplePortraitSvg);\n})();\n`;
}

async function main() {
  try {
    const { overlays, portraitSvg } = await loadConfig();
    const overlaysWithSvg = await loadOverlaySvgs(overlays);
    const fileContents = buildFileContents(portraitSvg, overlaysWithSvg);
    await fs.writeFile(outputFile, fileContents, 'utf8');
    console.log('[sync-try-on-demo] Updated assets/js/try-on-data.js');
  } catch (error) {
    console.error('[sync-try-on-demo] Failed to sync demo data:', error.message);
    process.exitCode = 1;
  }
}

main();
